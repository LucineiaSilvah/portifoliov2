"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,_toPropertyKey(i.key),i)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){t=_toPrimitive(t,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0===n)return("string"===e?String:Number)(t);n=n.call(t,e||"default");if("object"!==_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}var FullScreenHandler=function(){function e(t){_classCallCheck(this,e),this.painel=this.createPanel(),this.imgSources=t.toArray().map(function(t){return t.src})}return _createClass(e,[{key:"toggleFullScreen",value:function(t){var e=this.painel.get(0);this.painel.show(),this.setImageSource(t),document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement?(this.exitFullScreen(),document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen()):e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}},{key:"setImageSource",value:function(t){this.painel.show(),this.painel.find("#full-screen__image").attr("src",this.imgSources[t]),this.active=t}},{key:"exitFullScreen",value:function(){this.active=null,this.painel.hide()}},{key:"createPreviousButton",value:function(){var e=this;return $('<button  class="button buttonAction partitura-download">Anterior</button> ').on("click",function(t){return e.previousSheet()})}},{key:"createNextButton",value:function(){var e=this;return $('<button  class="button buttonAction partitura-download">Pr√≥ximo</button> ').on("click",function(t){return e.nextSheet()})}},{key:"createExitButton",value:function(){var e=this;return $('<button  class="button buttonAction partitura-download">Sair</button> ').on("click",function(t){return e.toggleFullScreen()})}},{key:"createPanel",value:function(){return $('<div class="full-screen__panel">\n\t\t\t\t<img id="full-screen__image" class="full-screen__image" src="" alt="">\n\t\t\t\t<div class="full-screen__actions">\n\t\t\t\t</div> \n\t\t\t</div>').hide().insertAfter(".task").find(".full-screen__actions").append(this.createPreviousButton()).append(this.createExitButton()).append(this.createNextButton()),$(".full-screen__panel")}},{key:"isInFullScreen",value:function(){return null!=document.webkitFullscreenElement||null!=document.mozFullScreenElement||null!=document.msFullscreenElement}},{key:"refreshListener",value:function(){var e=this;$("body").on("keyup",function(t){e.isInFullScreen()&&("37"==t.which||"40"==t.which?e.previousSheet():"38"==t.which||"39"==t.which?e.nextSheet():"27"==t.which&&e.toggleFullScreen())}),document.addEventListener("fullscreenchange",function(t){return!e.isInFullScreen()&&e.exitFullScreen()}),document.addEventListener("mozfullscreenchange",function(t){return!e.isInFullScreen()&&e.exitFullScreen()}),document.addEventListener("webkitfullscreenchange",function(t){return!e.isInFullScreen()&&e.exitFullScreen()})}},{key:"nextSheet",value:function(){this.active=(this.active+1)%this.imgSources.length,this.setImageSource(this.active)}},{key:"previousSheet",value:function(){this.active=Math.abs((this.active-1)%this.imgSources.length),this.setImageSource(this.active)}}]),e}(),MusicSheet=function(){function e(){var t=this;_classCallCheck(this,e),this.partituras=$(".partitura"),this.elements={musicSheets:function(){return t.partituras}},this.taskTitle=$(".task-body-header-title-text").text(),this.settings=$(".settings-box-list"),this.fullScreenHandler=new FullScreenHandler(this.partituras),this.fullScreenHandler.refreshListener()}return _createClass(e,[{key:"init",value:function(){this.setupListeners(),this.createDownloadButtons(),1<this.partituras.length&&this.createDownloadsSettings()}},{key:"createDownloadButtons",value:function(){var o=this;this.elements.musicSheets().each(function(n,i){var t=i.src,r=i.alt||"".concat(o.taskTitle," - partitura ").concat(n+1,".").concat(t.split(".").pop());o.isMobile()?$(i).after("<div class=\"partitura-download__wrapper\"><a class='button buttonAction partitura-download' href='".concat(t,"' download='").concat(r,"' title='").concat(r,"' target='_blank'>Download</a></div>")):o.toDataURL(t,function(t){var e="<button class='button buttonAction partitura-download' id='sheet-view-".concat(n,"' title='").concat(r,"'>Visualizar</button>"),t="<a class='button buttonAction partitura-download' href='".concat(t,"' download='").concat(r,"' title='").concat(r,"' target='_blank'>Download</a>");$(i).after('<div class="partitura-download__wrapper">'.concat(t," ").concat(e,"</div>")),$("#sheet-view-".concat(n)).on("click",function(t){return o.fullScreenHandler.toggleFullScreen(n)})})})}},{key:"createDownloadsSettings",value:function(){var e=this;$('<li class="settings-box-item settings-box-item-partituras"><button class="download-partituras">Baixar todas as imagens</button></li>').on("click",function(t){return e.downloads()}).appendTo(this.settings)}},{key:"toDataURL",value:function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"jpg",i=new Image;i.crossOrigin="Anonymous",i.onload=function(){var t=document.createElement("CANVAS"),t=(t.height=this.naturalHeight,t.width=this.naturalWidth,t.getContext("2d").drawImage(this,0,0),t.toDataURL(n));e(t)},i.src=t+"?"+Math.random()}},{key:"downloads",value:function(){$("a.partitura-download").each(function(){$(this)[0].click()})}},{key:"isMobile",value:function(){return 0==document.location.pathname.indexOf("/mobile/")}},{key:"setupListeners",value:function(){var n=this;this.elements.musicSheets().each(function(e,t){return $(t).on("click",function(t){return n.fullScreenHandler.toggleFullScreen(e)})})}}]),e}();(new MusicSheet).init();